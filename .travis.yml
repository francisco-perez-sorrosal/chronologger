language: python

python:
  - "3.6"
  - "3.7"
  - "3.8"

install:
  - pip install -r requirements_dev.txt

script:
  - pytest

after_success:
  - coveralls

stages:
- test
- 'Bump Version'
- deploy

jobs:
  include:
    - stage: 'Bump Version'
      python: '3.7'
      script: skip
      after_success:
        - echo "Creating and pushing new build version to master"
        - bumpversion --verbose --allow-dirty build --message "[skip travis] Bumping version from {current_version} -> {new_version}"
        - git remote add origin-version https://${GH_TOKEN}@github.com/francisco-perez-sorrosal/chronologger.git > /dev/null 2>&1
        - git checkout -b bump_version
        - git --no-pager log --oneline -n 5
        - git push origin-version bump_version:master
        - echo "Sending coverage report..."

    - stage: deploy
      python: '3.8'
      install: skip  # no tests, no depedencies needed
      script: skip  # we're not running tests
      deploy:
        provider: pypi
        distributions: "sdist bdist_wheel"
        skip_upload_docs: true
        skip_cleanup: true
        server: https://test.pypi.org/legacy/
        user: "__token__"
        password:
          secure: ${PYPI_TEST_TOKEN}
        on:
          tags: false
          repo: francisco-perez-sorrosal/chronologger
